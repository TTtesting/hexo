---
title: QQ好友在线/离线，怎么测试？
id: 120
categories:
  - 未分类
date: 2017-06-10 20:54:14
tags:
---

即时通讯是目前internet上最为流行的通讯方式，各种各样的即时通讯软件也层出不穷，那么今天主要针对QQ好友在线状态/QQ群友在线状态功能出发，一起思考其中的实现原理以及我们如何去测试此功能？

&nbsp;

当大家在使用QQ的时候，是否和我一样有如下疑问：

&nbsp;
> 在好友列表中为什么可以实时的看到qq好友的在线、离线等状态？> 
> 
> 在QQ群的群友列表中能看到当前群友的在线、离线等状态，是如何实现的？> 
> 
> 作为测试工程师究竟该如何去测试里面用到的技术？
&nbsp;

我带着这些问题，去搜集了一些资料进行了解、学习和总结后，现分享给大家。

关于QQ好友在线/离线状态我所理解的流程是：
> 当用户A登录成功时，服务器要把用户A的在线状态（online）写到缓存（高可用的缓存集群里）；userid-A—》login—》server—》set status in cache（userid：online）> 
> 
> 当用户A下线（登出）时，服务器要找到用户A的缓存将在线状态（online）变成离线状态（offline）；userid-A—》loginout—》server—》update status in cache（userid-A：offline）> 
> 
> 其他所有用户的状态都会存储在缓存中，所以当用户A登录时，从数据库中查出用户A的好友，再从缓存中查出这些好友所对应的在线状态，从而用户A可以看出哪些好友在线哪些好友离线；> 
> 
> userid-A—》my friends status—》get friends userids in DB —》get userids status in cache（userid1:online，userid2:offline，userid3:offline，userid4:online……）
&nbsp;

针对上面的流程主要考虑的测试点如下：
> 无缓存情况下，用户A登录时，写入缓存正常（缓存大家应该都了解过，比如memcache、redis等如何查看缓存？不会的同学可以咨询也可自己查下相关资料）> 
> 
> 当用户退出登录时，缓存中对应的value被置为offline；> 
> 
> 缓存存的有效期校验；> 
> 
> 用户A的好友用户B下线/上线时，状态是否显示正确；> 
> 
> 用户A的多个好友中有在线有离线的，当用户A查看好友状态时，状态显示是否正确；> 
> 
> 当redis连接异常或超时时，应该如何处理；
等等...大家可以想想需要测试的功能点，要了解开发实现的过程，尽可能的去覆盖测试点。

&nbsp;

写到这里，其实其中还有一个重要的点：比如用户A的好友用户B在线，突然，用户B离线了，那么用户A能否立即看到好友由在线变成离线呢？这也是我们测试人员需要考虑的功能点！到底是不是实时的我也不能确定，如果有人知道的话可以分享下。如果对实时性要求较高，可以采用推送的方式同步，如果实时性要求不太高的话，可以采用轮询拉取的方式进行同步。

&nbsp;

再普及下轮询拉取方式和推送方式，如下：

&nbsp;
> 什么是轮询拉取方式
举例说明：用户userid-A要看到好友的在线状态的话，比如就要每分钟轮询向服务器拉取全部好友的在线状态。缺点就是：有一分钟的延迟，同时当好友的状态期间没有变化时也请求服务器拉取产生大量的无效请求暂用服务器的资源。这种方式可能大家在工作中也经常用到，不断的轮询获取服务器的信息。

&nbsp;

&nbsp;
> 什么是推送的方式
继续举例说明：还是用户userid-A要看到好友用户userid-B在线状态的话，当用户userid-B下线时，由在线变成离线（更新缓存为offline），同时要将这个状态改变的通知推送给用户userid-B的在线反向好友。这样就变成实时了，但是缺点就是：在线好友量大的话，任何一个用户状态的改变会扩散很多实时通知，需要考虑承载能力。

&nbsp;

大家可以思考下，QQ群友的在线同步应该是怎样的流程呢？到底是使用轮询的方式还是推送的方式呢？后续如果有时间的话可以继续讨论。